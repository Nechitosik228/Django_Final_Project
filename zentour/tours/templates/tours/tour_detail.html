{% extends 'tours/base.html' %}
{% load static %}

{% block title %}{{ tour.name }}{% endblock %}

{% block style %}
    <style type="text/css">
        .image {
        float: left;
        width: 50%;
        height: 30%;
        margin-right: 30px;
        position: sticky;
        top: 0;
        }

        .text-success {
            font-size: 50px;  
        }

        p {
            font-size: 20px;
        }

        span {
            font-size: 25px;
        }

        .checked {
            color: orange;
        }

        .fa {
            width: 10px;
        }
        
        .tour {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

    </style>
{% endblock %}

{% block content %}

    <div class="tour">
        <img src="{{ tour.image.url|default:'https://fotografie.at/galerie/userImages/33/484922-33adeea9.jpg' }}" alt="{{ tour.name }}" class="image">
        <div class="tour-text">
        <h1>{{ tour.name }}</h1>
        <p>{{ tour.description }}</p>
        
        <p>Dates: {{ tour.start_date }} - {{ tour.end_date }}</p>
        {% if tour.available %}
            <p>Tickets left: {{ tour.tickets_amount }}</p>
        {% else %}
            <p class="text-muted">Sold out</p>
        {% endif %}
        <p>Cities: {{ tour.cities }}</p>
        {% if tour.rating  %}
                <ul class="list-group-item">
                {% for _ in full_stars %}
                    <span class="fa fa-star checked"></span>
                {% endfor %}
                {% if has_half_star %}
                    <span class="fa fa-star-half-o checked"></span>
                {% endif %}
                {% for _ in empty_stars %}
                    <span class="fa fa-star-o"></span>
                {% endfor %}
                </ul>
        {% else %}
            <p style="color: gray;">No reviews</p>
        {% endif %}
        {% if tour.discount %}
            <span class="text-success">
                Ticket price: ${{ tour.discount_price }}
            </span>
            <span class="text-muted text-decoration-line-through">
                ${{ tour.price }}
            </span>
            <span>
                Discount: {{ tour.discount }}%
            </span>
        {% else %}
            <p class="text-success">
                Ticket price: ${{ tour.price }}
            </p>  
        {% endif %}
        </div>
    </div>
    <div class="reviews">

        {% if user.is_authenticated %}
            <hr>
            <h2>Leave a review</h2>
            <form method="POST" action="{% url 'tours:submit_review' tour.id %}">
                {% csrf_token %}

                {{ form.comment.label_tag }}
                {{ form.comment }}

                <label for="star-rating">Rating (1â€“5):</label>
                <div id="star-rating">
                    {% for i in "12345" %}
                        <span class="fa fa-star star" data-value="{{ forloop.counter }}"></span>
                    {% endfor %}
                </div>

                {% with form.rating as rating_field %}
                    {{ rating_field }}
                    <style>
                        input[name="{{ rating_field.html_name }}"] {
                            display: none;
                        }
                    </style>
                {% endwith %}


                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
            {% else %}
            <p><a href="{% url 'accounts:login' %}?next={{ request.path }}">Log in</a> to leave a review.</p>
        {% endif %}
        
        <hr>
        <h2>Reviews</h2>
        {% for review in tour.reviews.all %}
            <div style="margin-bottom: 20px;">
                <p><strong>{{ review.user.username }}</strong> rated:</p>
                {% for _ in review.full_stars %}
                    <span class="fa fa-star checked"></span>
                {% endfor %}
                {% if review.has_half_star %}
                    <span class="fa fa-star-half-o checked"></span>
                {% endif %}
                {% for _ in review.empty_stars %}
                    <span class="fa fa-star"></span>
                {% endfor %}
                <p>{{ review.comment }}</p>
            </div>
        {% empty %}
            <p>No reviews yet.</p>
        {% endfor %}
    </div>
    <script src="{% static 'js/review_star.js' %}"></script>
{% endblock %}